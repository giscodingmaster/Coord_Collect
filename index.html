<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ø­ÙˆÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª - Firebase Edition</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS (XLSX) for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel Standalone for in-browser JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://rsms.me/inter/inter.css');
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        //======================================================================
        // BUNDLED REACT + FIREBASE APPLICATION
        //======================================================================

        const { useState, useEffect, useCallback, useMemo, useRef } = React;
        const { createRoot } = ReactDOM;
        
        // Correctly import Firebase v9 SDK functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        //======================================================================
        // 1. FIREBASE CONFIGURATION (IMPORTANT!)
        //======================================================================

        const firebaseConfig = {
          apiKey: "AIzaSyBZByigYzVFczxSpLnhxbHMZURWfQCjpW8",
          authDomain: "coord-collect.firebaseapp.com",
          databaseURL: "https://coord-collect-default-rtdb.firebaseio.com",
          projectId: "coord-collect",
          storageBucket: "coord-collect.appspot.com",
          messagingSenderId: "694407331617",
          appId: "1:694407331617:web:6c3e3f90ba82c465cac860",
          measurementId: "G-Y0K8C4YBWV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const recordsRef = ref(db, 'records');

        //======================================================================
        // 2. TYPES & SERVICES
        //======================================================================

        // --- Types ---
        // CoordinateRecord is implicitly defined by its usage

        // --- Conversion Service ---
        function wgs84ToUtm(lat, lon) {
            const a = 6378137.0;
            const e = 0.0818191908426;
            const k0 = 0.9996;
            const lonOrigin = 33;
            const falseEasting = 500000;
            const falseNorthing = 0;

            const latRad = lat * Math.PI / 180;
            const lonRad = lon * Math.PI / 180;
            const lonOriginRad = lonOrigin * Math.PI / 180;

            const N = a / Math.sqrt(1 - Math.pow(e * Math.sin(latRad), 2));
            const T = Math.pow(Math.tan(latRad), 2);
            const C = Math.pow(e * Math.cos(latRad), 2) / (1 - Math.pow(e, 2));
            const A = (lonRad - lonOriginRad) * Math.cos(latRad);

            const M = a * ((1 - Math.pow(e, 2) / 4 - 3 * Math.pow(e, 4) / 64 - 5 * Math.pow(e, 6) / 256) * latRad
                - (3 * Math.pow(e, 2) / 8 + 3 * Math.pow(e, 4) / 32 + 45 * Math.pow(e, 6) / 1024) * Math.sin(2 * latRad)
                + (15 * Math.pow(e, 4) / 256 + 45 * Math.pow(e, 6) / 1024) * Math.sin(4 * latRad)
                - (35 * Math.pow(e, 6) / 3072) * Math.sin(6 * latRad));

            const x = k0 * N * (A + (1 - T + C) * Math.pow(A, 3) / 6
                + (5 - 18 * T + Math.pow(T, 2) + 72 * C - 58 * Math.pow(e, 2)) * Math.pow(A, 5) / 120) + falseEasting;

            const y = k0 * (M + N * Math.tan(latRad) * (Math.pow(A, 2) / 2
                + (5 - T + 9 * C + 4 * Math.pow(C, 2)) * Math.pow(A, 4) / 24
                + (61 - 58 * T + Math.pow(T, 2) + 600 * C - 330 * Math.pow(e, 2)) * Math.pow(A, 6) / 720)) + falseNorthing;

            return { x: x.toFixed(4), y: y.toFixed(4) };
        }

        function extractCoordinates(url) {
            const patterns = [
                /@(-?\d+\.\d+),(-?\d+\.\d+)/,
                /!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/,
                /place\/(-?\d+(?:\.\d+)?)[Â°%](\d+(?:\.\d+)?)'([\d.]+)"([NS])\+(-?\d+(?:\.\d+)?)[Â°%](\d+(?:\.\d+)?)'([\d.]+)"([EW])/
            ];

            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    if (pattern === patterns[2]) {
                        let lat = parseFloat(match[1]) + parseFloat(match[2])/60 + parseFloat(match[3])/3600;
                        let lon = parseFloat(match[5]) + parseFloat(match[6])/60 + parseFloat(match[7])/3600;
                        if (match[4] === 'S') lat = -lat;
                        if (match[8] === 'W') lon = -lon;
                        return { lat, lon };
                    } else {
                        return { 
                            lat: parseFloat(match[1]), 
                            lon: parseFloat(match[2]) 
                        };
                    }
                }
            }
            return null;
        }

        //======================================================================
        // 3. REACT COMPONENTS
        //======================================================================

        // --- Alert Component ---
        const Alert = ({ message, type }) => {
            const baseClasses = "flex items-center p-4 min-w-[320px] max-w-md bg-white rounded-lg shadow-lg border-l-4";
            const typeClasses = {
                success: "border-green-500",
                error: "border-red-500",
            };
            const iconClasses = {
                success: "text-green-500",
                error: "text-red-500",
            }

            return (
                <div className={`${baseClasses} ${typeClasses[type]}`} role="alert">
                    <div className={`inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg ${iconClasses[type]}`}>
                        {type === 'success' ? 
                            <svg className="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/>
                            </svg> :
                            <svg className="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM10 15a1 1 0 1 1 0-2 1 1 0 0 1 0 2Zm1-4a1 1 0 0 1-2 0V6a1 1 0 0 1 2 0v5Z"/>
                            </svg>
                        }
                    </div>
                    <div className="ms-3 text-sm font-medium text-gray-700">
                        {message}
                    </div>
                </div>
            );
        };
        
        // --- EmptyState Component ---
        const EmptyState = () => {
            return (
                <div className="text-center py-24 px-6 text-gray-500 border-2 border-dashed border-gray-300 rounded-lg mt-4">
                    <svg className="w-16 h-16 mx-auto mb-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" d="M9 13.5l3 3m0 0l3-3m-3 3v-6m1.06-4.19l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
                    </svg>
                    <h3 className="text-lg font-semibold text-gray-700">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</h3>
                    <p className="mt-2 text-sm">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±</p>
                </div>
            );
        };

        // --- Header Component ---
        const Header = ({ recordCount }) => {
            return (
                <header className="bg-white text-gray-800 p-6 border-b border-gray-200 flex justify-between items-center">
                    <h1 className="text-2xl font-semibold">
                        <span role="img" aria-label="map icon" className="mr-3">ğŸ—ºï¸</span>
                        Ù…Ø­ÙˆÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
                    </h1>
                    <div className="bg-gray-100 text-gray-600 px-4 py-1.5 rounded-full text-sm font-medium">
                        <span role="img" aria-label="chart icon" className="mr-2">ğŸ“Š</span>
                        <span id="recordCount">{recordCount}</span> Ø³Ø¬Ù„
                    </div>
                </header>
            );
        };

        // --- KbdShortcut Component ---
        const KbdShortcut = ({ children }) => (
            <span className="inline-block px-1.5 py-0.5 bg-gray-100 border border-gray-300 rounded text-gray-600 text-[10px] font-mono ms-2">
                {children}
            </span>
        );
        
        // --- FormPanel Component ---
        const FormPanel = ({
            entityName, setEntityName, crn, setCrn, googleLink, setGoogleLink, comment, setComment,
            quickResult, setQuickResult, handleSubmit, handleExport, handleClearAll, isEditing, entityNameRef
        }) => {
            
            const handlePaste = useCallback((e) => {
                const pastedText = e.clipboardData.getData('text');
                setTimeout(() => {
                    const url = pastedText;
                    const coords = extractCoordinates(url);
                    if (coords) {
                        const utm = wgs84ToUtm(coords.lat, coords.lon);
                        setQuickResult(utm);
                    } else {
                        setQuickResult(null);
                    }
                }, 100);
            }, [setQuickResult]);

            return (
                <div className="bg-gray-50 p-6 border-s-0 lg:border-s-2 border-gray-200 max-h-[calc(100vh-160px)] lg:max-h-auto overflow-y-auto">
                    <form onSubmit={handleSubmit} className="flex flex-col h-full">
                        <div className="flex-grow">
                            <div className="mb-4">
                                <label htmlFor="entityName" className="block mb-1.5 font-medium text-gray-600 text-xs uppercase tracking-wider">
                                    Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø© *<KbdShortcut>Alt+1</KbdShortcut>
                                </label>
                                <input
                                    type="text"
                                    id="entityName"
                                    ref={entityNameRef}
                                    value={entityName}
                                    onChange={(e) => setEntityName(e.target.value)}
                                    required
                                    placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©"
                                    accessKey="1"
                                    autoComplete="off"
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                                />
                            </div>

                            <div className="mb-4">
                                <label htmlFor="crn" className="block mb-1.5 font-medium text-gray-600 text-xs uppercase tracking-wider">
                                    CRN *<KbdShortcut>Alt+2</KbdShortcut>
                                </label>
                                <input
                                    type="text"
                                    id="crn"
                                    value={crn}
                                    onChange={(e) => setCrn(e.target.value)}
                                    required
                                    placeholder="Ø±Ù‚Ù… CRN"
                                    accessKey="2"
                                    autoComplete="off"
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                                />
                            </div>

                            <div className="mb-4">
                                <label htmlFor="googleLink" className="block mb-1.5 font-medium text-gray-600 text-xs uppercase tracking-wider">
                                    Ø±Ø§Ø¨Ø· Google Maps *<KbdShortcut>Alt+3</KbdShortcut>
                                </label>
                                <textarea
                                    id="googleLink"
                                    value={googleLink}
                                    onChange={(e) => setGoogleLink(e.target.value)}
                                    onPaste={handlePaste}
                                    required
                                    placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§"
                                    accessKey="3"
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-sm resize-none min-h-[70px] focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                                ></textarea>
                                <div className="text-xs text-gray-500 mt-1">ÙŠØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ù„ØµÙ‚</div>
                            </div>

                            <div className="mb-5">
                                <label htmlFor="comment" className="block mb-1.5 font-medium text-gray-600 text-xs uppercase tracking-wider">
                                    Ù…Ù„Ø§Ø­Ø¸Ø§Øª<KbdShortcut>Alt+4</KbdShortcut>
                                </label>
                                <textarea
                                    id="comment"
                                    value={comment}
                                    onChange={(e) => setComment(e.target.value)}
                                    placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"
                                    accessKey="4"
                                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-sm resize-none min-h-[70px] focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                                ></textarea>
                            </div>

                            {quickResult && (
                                <div className="bg-blue-50 border border-blue-200 text-blue-800 p-3 rounded-md mb-4 font-mono text-sm">
                                    <strong className="font-sans font-semibold">{isEditing ? 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„:' : 'âœ“ ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„:'}</strong><br />
                                    x = {quickResult.x}<br />
                                    y = {quickResult.y}
                                </div>
                            )}
                        </div>
                        
                        <div className="sticky bottom-0 bg-gray-50 pt-4 -mb-6 -mx-6 px-6 pb-6 border-t border-gray-200">
                             <button type="submit" className="w-full text-white font-bold py-3 px-4 rounded-md transition duration-150 ease-in-out bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 mb-2.5">
                                {isEditing ? 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„' : 'âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„'} <KbdShortcut>Enter</KbdShortcut>
                            </button>
                            <div className="grid grid-cols-2 gap-2.5">
                                <button type="button" onClick={handleExport} className="w-full bg-white border border-gray-300 hover:bg-gray-100 text-gray-800 font-bold py-3 px-4 rounded-md transition duration-150 ease-in-out">
                                    ğŸ“¥ ØªØµØ¯ÙŠØ±
                                </button>
                                <button type="button" onClick={handleClearAll} className="w-full bg-red-50 hover:bg-red-100 text-red-700 font-bold py-3 px-4 rounded-md transition duration-150 ease-in-out border border-red-200">
                                    ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            );
        };
        
        // --- TablePanel Component ---
        const TablePanel = ({ records, searchTerm, setSearchTerm, onEdit, onDelete }) => {
            return (
                <div className="p-4 sm:p-8 max-h-[calc(100vh-160px)] lg:max-h-auto overflow-y-auto">
                    <div className="relative mb-4">
                         <input
                            type="text"
                            id="searchBox"
                            placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full ps-10 pe-4 py-2.5 bg-gray-50 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                        />
                        <div className="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
                            <svg className="w-4 h-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                                <path stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
                            </svg>
                        </div>
                    </div>
                    
                    {records.length === 0 && !searchTerm ? (
                        <EmptyState />
                    ) : (
                        <div className="overflow-x-auto border border-gray-200 rounded-lg">
                            <table className="min-w-full divide-y divide-gray-200 text-sm text-right text-gray-600">
                                <thead className="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©</th>
                                        <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">CRN</th>
                                        <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">X</th>
                                        <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Y</th>
                                        <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                        <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</th>
                                        <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {records.map((record, index) => (
                                        <tr key={record.id} className={index % 2 === 0 ? undefined : 'bg-gray-50'}>
                                            <td className="px-6 py-4 whitespace-nowrap font-medium text-gray-900">{record.entityName}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">{record.crn}</td>
                                            <td className="px-6 py-4 whitespace-nowrap font-mono text-gray-800">{record.x}</td>
                                            <td className="px-6 py-4 whitespace-nowrap font-mono text-gray-800">{record.y}</td>
                                            <td className="px-6 py-4 max-w-[200px] overflow-hidden text-ellipsis whitespace-nowrap" title={record.comment}>{record.comment || '-'}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-xs text-gray-500">{record.updated || record.timestamp}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-left">
                                                <button onClick={() => onEdit(record.id)} className="text-blue-600 hover:text-blue-800 font-medium py-1 px-2 rounded-md transition-colors">ØªØ¹Ø¯ÙŠÙ„</button>
                                                <button onClick={() => onDelete(record.id)} className="text-red-600 hover:text-red-800 font-medium py-1 px-2 rounded-md transition-colors mr-2">Ø­Ø°Ù</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                     {records.length === 0 && searchTerm && (
                        <div className="text-center py-16 px-5 text-gray-500">
                            <h3 className="text-xl font-semibold text-gray-700">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø­Ø«</h3>
                            <p className="mt-2">Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØµØ·Ù„Ø­ Ø¨Ø­Ø« Ù…Ø®ØªÙ„Ù</p>
                        </div>
                    )}
                </div>
            );
        };
        
        // --- Main App Component ---
        const App = () => {
            const [records, setRecords] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [alert, setAlert] = useState(null);

            const [entityName, setEntityName] = useState('');
            const [crn, setCrn] = useState('');
            const [googleLink, setGoogleLink] = useState('');
            const [comment, setComment] = useState('');
            const [quickResult, setQuickResult] = useState(null);
            
            const entityNameRef = useRef(null);

            useEffect(() => {
                entityNameRef.current?.focus();
                
                // Subscribe to real-time updates from Firebase
                const unsubscribe = onValue(recordsRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const recordsList = Object.keys(data).map(key => ({
                            id: key,
                            ...data[key]
                        })).sort((a, b) => b.createdAt - a.createdAt); // Sort by creation time descending
                        setRecords(recordsList);
                    } else {
                        setRecords([]);
                    }
                });

                // Cleanup subscription on component unmount
                return () => unsubscribe();
            }, []);

            const showAlert = (message, type) => {
                setAlert({ message, type });
                setTimeout(() => setAlert(null), 3000);
            };

            const resetForm = useCallback(() => {
                setEntityName('');
                setCrn('');
                setGoogleLink('');
                setComment('');
                setQuickResult(null);
                setEditingId(null);
                entityNameRef.current?.focus();
            }, []);

            const handleSubmit = (e) => {
                e.preventDefault();

                const coords = extractCoordinates(googleLink);
                if (!coords) {
                    showAlert('Ø±Ø§Ø¨Ø· Google Maps ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…', 'error');
                    return;
                }

                const utm = wgs84ToUtm(coords.lat, coords.lon);
                
                if (editingId) {
                    const recordToUpdateRef = ref(db, `records/${editingId}`);
                    const updatedRecord = {
                        ...records.find(r => r.id === editingId), // preserve original data
                        entityName,
                        crn,
                        x: utm.x,
                        y: utm.y,
                        lat: coords.lat.toFixed(7),
                        lon: coords.lon.toFixed(7),
                        comment,
                        updated: new Date().toLocaleString('ar-EG'),
                    };
                    set(recordToUpdateRef, updatedRecord)
                        .then(() => showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success'))
                        .catch(err => showAlert(`Ø®Ø·Ø£: ${err.message}`, 'error'));
                } else {
                    const newRecordRef = push(recordsRef);
                    const newRecord = {
                        entityName,
                        crn,
                        x: utm.x,
                        y: utm.y,
                        lat: coords.lat.toFixed(7),
                        lon: coords.lon.toFixed(7),
                        comment,
                        timestamp: new Date().toLocaleString('ar-EG'),
                        createdAt: Date.now() // For sorting
                    };
                    set(newRecordRef, newRecord)
                        .then(() => showAlert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success'))
                        .catch(err => showAlert(`Ø®Ø·Ø£: ${err.message}`, 'error'));
                }
                resetForm();
            };
            
            const handleEdit = (id) => {
                const record = records.find(r => r.id === id);
                if (record) {
                    setEntityName(record.entityName);
                    setCrn(record.crn);
                    setComment(record.comment || '');
                    setGoogleLink(`https://maps.google.com/?q=${record.lat},${record.lon}`);
                    setQuickResult({ x: record.x, y: record.y });
                    setEditingId(id);
                    entityNameRef.current?.focus();
                }
            };
            
            const handleDelete = (id) => {
                if (window.confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) {
                    const recordToDeleteRef = ref(db, `records/${id}`);
                    remove(recordToDeleteRef)
                        .then(() => showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„', 'success'))
                        .catch(err => showAlert(`Ø®Ø·Ø£: ${err.message}`, 'error'));
                }
            };
            
            const handleClearAll = () => {
                if (window.confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŸ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§.')) {
                    remove(recordsRef)
                        .then(() => showAlert('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª', 'success'))
                        .catch(err => showAlert(`Ø®Ø·Ø£: ${err.message}`, 'error'));
                }
            };

            const handleExport = () => {
                if (records.length === 0) {
                    showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§', 'error');
                    return;
                }
                
                const data = records.map(r => ({
                    'Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©': r.entityName,
                    'CRN': r.crn,
                    'X': r.x,
                    'Y': r.y,
                    'Latitude': r.lat,
                    'Longitude': r.lon,
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': r.comment || '',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡': r.timestamp,
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«': r.updated || ''
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Coordinates");
                const fileName = `utm_coordinates_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                showAlert('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
            };

            const filteredRecords = useMemo(() => {
                if (!searchTerm) return records;
                return records.filter(record =>
                    Object.values(record).some(value =>
                        String(value).toLowerCase().includes(searchTerm.toLowerCase())
                    )
                );
            }, [records, searchTerm]);

            return (
                <div className="bg-gray-100 min-h-screen p-4 sm:p-8">
                    <div className="container max-w-7xl mx-auto bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                        <Header recordCount={records.length} />
                        <main className="grid grid-cols-1 lg:grid-cols-[420px_1fr] gap-0">
                            <FormPanel
                                entityName={entityName}
                                setEntityName={setEntityName}
                                crn={crn}
                                setCrn={setCrn}
                                googleLink={googleLink}
                                setGoogleLink={setGoogleLink}
                                comment={comment}
                                setComment={setComment}
                                quickResult={quickResult}
                                setQuickResult={setQuickResult}
                                handleSubmit={handleSubmit}
                                handleExport={handleExport}
                                handleClearAll={handleClearAll}
                                isEditing={!!editingId}
                                entityNameRef={entityNameRef}
                            />
                            <TablePanel
                                records={filteredRecords}
                                searchTerm={searchTerm}
                                setSearchTerm={setSearchTerm}
                                onEdit={handleEdit}
                                onDelete={handleDelete}
                            />
                        </main>
                         {alert && (
                            <div className="fixed top-5 right-1/2 translate-x-1/2 z-50">
                                <Alert message={alert.message} type={alert.type} />
                            </div>
                         )}
                    </div>
                </div>
            );
        };

        //======================================================================
        // 4. RENDER THE APPLICATION
        //======================================================================
        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
